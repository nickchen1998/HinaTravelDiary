{% extends 'base.html' %}

{% block content %}
    <!-- 麵包屑導航 -->
    <div class="breadcrumbs text-sm mb-6">
        <ul>
            <li><a href="/">首頁</a></li>
            <li><a href="/journeys/{{ itinerary.journey.id }}/itineraries/">{{ itinerary.journey.title }}</a></li>
            <li>行程列表</li>
            <li>{{ itinerary.title }}</li>
            <li>景點列表</li>
        </ul>
    </div>

    <!-- 行程資訊 -->
    <div class="hero bg-gradient-to-r from-accent/10 to-primary/10 rounded-lg mb-8">
        <div class="hero-content text-center">
            <div class="max-w-md">
                <h1 class="text-4xl font-bold text-primary mb-4">
                    <i class="fas fa-map-marked-alt mr-3"></i>
                    {{ itinerary.title }}
                </h1>
                <p class="py-6">{{ itinerary.description }}</p>
                <div class="flex justify-center items-center gap-4 text-sm">
                    <div class="badge badge-primary badge-outline">
                        <i class="fas fa-route mr-1"></i>
                        {{ itinerary.journey.title }}
                    </div>
                    <div class="badge badge-secondary badge-outline">
                        <i class="fas fa-calendar mr-1"></i>
                        {{ itinerary.start_date|date:"Y年m月d日" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 地圖區域 -->
    {% if locations %}
        <div class="mb-8">
{#            <div class="text-center mb-6">#}
{#                <h2 class="text-3xl font-bold text-base-content mb-4">#}
{#                    <i class="fas fa-map text-primary mr-2"></i>#}
{#                    景點地圖#}
{#                </h2>#}
{#                <p class="text-lg text-base-content opacity-70">#}
{#                    所有景點的地理位置一覽#}
{#                </p>#}
{#            </div>#}

            <div class="card bg-base-100 shadow-xl mb-8">
                <div class="card-body p-0">
                    <div id="map" style="height: 400px; width: 100%; border-radius: 1rem;"></div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- 景點列表 -->
    <div class="mb-8">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-base-content mb-4">
                <i class="fas fa-map-marker-alt text-error mr-2"></i>
                景點列表
            </h2>
            <p class="text-lg text-base-content opacity-70">
                探索這個行程的所有精彩景點
            </p>

            <!-- 新增地點按鈕 -->
            <div class="mt-6">
                <button onclick="openCreateLocationModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    新增地點
                </button>
            </div>
        </div>

        {% if locations %}
            <!-- 時段分組顯示 - 電腦版三欄，手機版垂直 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {% for time_slot_key, time_slot_data in locations_by_time_slot.items %}
                    <div class="time-slot-section" data-time-slot="{{ time_slot_key }}">
                        <!-- 時段標題 -->
                        <div class="flex items-center gap-3 mb-4">
                            <div class="badge badge-lg badge-primary gap-2">
                                <i class="fas {{ time_slot_data.icon }}"></i>
                                {{ time_slot_data.title }}
                            </div>
                            <div class="text-sm text-base-content opacity-60">
                                共 {{ time_slot_data.locations|length }} 個地點
                            </div>
                        </div>
                        
                        <!-- 該時段的地點列表 -->
                        <div class="locations-container space-y-4 min-h-[200px] p-4 bg-base-200 rounded-lg" id="locationsList-{{ time_slot_key }}">
                            {% if time_slot_data.locations %}
                                {% for location in time_slot_data.locations %}
                                    <div class="location-item card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 cursor-move"
                                         data-location-id="{{ location.id }}"
                                         data-time-slot="{{ time_slot_key }}"
                                         draggable="true">
                                        <div class="card-body">
                            <!-- 桌面版：左右佈局，手機版：上下佈局 -->
                            <div class="flex flex-col lg:flex-row items-start gap-6">
                                <!-- 順序標籤和拖拉指示器 -->
                                <div class="flex-shrink-0 flex flex-col items-center gap-2">
                                    <div class="badge badge-primary badge-lg">
                                        <i class="fas fa-map-pin mr-1"></i>
                                        {{ location.order|default:forloop.counter }}
                                    </div>
                                    <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing">
                                        <i class="fas fa-grip-vertical text-lg"></i>
                                    </div>
                                </div>

                                <!-- 景點資訊 -->
                                <div class="flex-1 min-w-0">
                                    <h3 class="card-title text-xl font-bold mb-3">
                                        {{ location.name }}
                                    </h3>

                                    <p class="text-base-content opacity-80 mb-4 leading-relaxed">
                                        {% if location.description %}
                                            {{ location.description }}
                                        {% else %}
                                            尚無描述或備注
                                        {% endif %}
                                    </p>

                                    <!-- 地點資訊 -->
                                    <div class="mb-4">
                                        {% if location.address %}
                                            <div class="text-sm text-base-content opacity-70">
                                                <i class="fas fa-map-marker-alt mr-1"></i>
                                                <span class="break-words">{{ location.address }}</span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="flex flex-wrap items-center gap-4 mb-4">
                                        {% if location.rating %}
                                            <div class="badge badge-warning badge-outline">
                                                <i class="fas fa-star mr-1"></i>
                                                {{ location.rating }}
                                            </div>
                                        {% endif %}

                                        {% if location.place_types %}
                                            <div class="badge badge-info badge-outline">
                                                <i class="fas fa-tag mr-1"></i>
                                                {{ location.place_types }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="flex flex-wrap items-center gap-4 mb-4">
                                        {% if location.google_maps_url %}
                                            <a href="{{ location.google_maps_url }}"
                                               target="_blank"
                                               class="btn btn-sm btn-outline btn-primary">
                                                <i class="fas fa-external-link-alt mr-1"></i>
                                                在 Google Maps 查看
                                            </a>
                                        {% endif %}
                                    </div>

                                    <!-- 時間資訊 -->
                                    <div class="flex flex-wrap items-center gap-4 mb-4">
                                        {% if location.arrived_hour is not None and location.arrived_minute is not None %}
                                            <div class="badge badge-outline">
                                                <i class="fas fa-clock mr-1"></i>
                                                抵達: {{ location.arrived_hour|stringformat:"02d" }}:{{ location.arrived_minute|stringformat:"02d" }}
                                            </div>
                                        {% endif %}
                                        {% if location.departure_hour is not None and location.departure_minute is not None %}
                                            <div class="badge badge-outline">
                                                <i class="fas fa-clock mr-1"></i>
                                                離開: {{ location.departure_hour|stringformat:"02d" }}:{{ location.departure_minute|stringformat:"02d" }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- 操作按鈕 -->
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="openEditLocationModal({{ location.id }}, '{{ location.name|escapejs }}', '{{ location.time_slot }}', {{ location.arrived_hour|default:'null' }}, {{ location.arrived_minute|default:'null' }}, {{ location.departure_hour|default:'null' }}, {{ location.departure_minute|default:'null' }})"
                                                class="btn btn-sm btn-outline btn-secondary">
                                            <i class="fas fa-edit mr-1"></i>
                                            編輯
                                        </button>
                                        <button onclick="deleteLocation({{ location.id }})"
                                                class="btn btn-sm btn-outline btn-error">
                                            <i class="fas fa-trash mr-1"></i>
                                            刪除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                            {% else %}
                                <div class="text-center py-8 text-base-content opacity-50">
                                    <i class="fas fa-clock text-2xl mb-2"></i>
                                    <p>此時段暫無地點</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="mb-4">
                    <i class="fas fa-exclamation-circle text-4xl text-warning"></i>
                </div>
                <h3 class="text-xl font-bold text-base-content mb-2">暫無景點</h3>
                <p class="text-base-content opacity-70">這個行程還沒有添加任何景點</p>
            </div>
        {% endif %}
    </div>

    <!-- 返回按鈕 -->
    <div class="flex justify-center gap-4 mt-8">
        <a href="/journeys/{{ itinerary.journey.id }}/itineraries/" class="btn btn-outline btn-primary">
            <i class="fas fa-arrow-left mr-2"></i>
            返回行程列表
        </a>
        <a href="/" class="btn btn-outline btn-secondary">
            <i class="fas fa-home mr-2"></i>
            返回首頁
        </a>
    </div>

    <!-- Google Maps JavaScript -->
    {% if locations %}
        <script>
            let mapData = null;
            let googleMapsLoaded = false;

            // 動態載入地圖資料
            async function loadMapData() {
                try {
                    const response = await fetch('/itineraries/{{ itinerary.id }}/map-data/');
                    if (!response.ok) {
                        throw new Error('無法載入地圖資料');
                    }
                    mapData = await response.json();

                    if (mapData.api_key) {
                        loadGoogleMapsAPI(mapData.api_key);
                    } else {
                        showError('warning', 'Google Maps API 金鑰未設定', '請在環境變數中設定 GOOGLE_MAPS_API_KEY');
                    }
                } catch (error) {
                    console.error('載入地圖資料失敗:', error);
                    showError('error', '載入地圖資料失敗', error.message);
                }
            }

            // 動態載入 Google Maps API
            function loadGoogleMapsAPI(apiKey) {
                if (googleMapsLoaded) return;

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                script.onerror = () => {
                    showError('error', 'Google Maps 載入失敗', '請檢查網路連線或 API 金鑰');
                };
                document.head.appendChild(script);
                googleMapsLoaded = true;
            }

            function showError(type, title, message) {
                const bgColor = type === 'error' ? 'bg-error/10' : 'bg-warning/10';
                const textColor = type === 'error' ? 'text-error' : 'text-warning';
                const icon = type === 'error' ? 'fa-exclamation-triangle' : 'fa-exclamation-triangle';

                document.getElementById('map').innerHTML =
                    `<div class="flex items-center justify-center h-full ${bgColor} rounded-xl">` +
                    '<div class="text-center">' +
                    `<i class="fas ${icon} text-4xl ${textColor} mb-4"></i>` +
                    `<p class="text-lg ${textColor}">${title}</p>` +
                    `<p class="text-sm text-base-content opacity-70">${message}</p>` +
                    '</div>' +
                    '</div>';
            }

            function initMap() {
                if (!mapData || !mapData.locations) {
                    showError('warning', '暫無地點座標資訊', '請在管理後台為景點添加 Google Maps 網址');
                    return;
                }

                const locations = mapData.locations;

                if (locations.length === 0) {
                    showError('warning', '暫無地點座標資訊', '請在管理後台為景點添加 Google Maps 網址');
                    return;
                }

                // 計算地圖中心點
                let bounds = new google.maps.LatLngBounds();
                locations.forEach(location => {
                    bounds.extend(new google.maps.LatLng(location.lat, location.lng));
                });

                // 初始化地圖
                const map = new google.maps.Map(document.getElementById('map'), {
                    center: bounds.getCenter(),
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{visibility: "on"}]
                        }
                    ]
                });

                // 調整地圖範圍以顯示所有標記
                map.fitBounds(bounds);

                // 創建路線路徑（按順序連接）
                const pathCoordinates = locations
                    .sort((a, b) => a.order - b.order)
                    .map(location => ({
                        lat: location.lat,
                        lng: location.lng
                    }));

                // 添加路線（直線連接）
                if (pathCoordinates.length > 1) {
                    const routePath = new google.maps.Polyline({
                        path: pathCoordinates,
                        geodesic: true,
                        strokeColor: '#3b82f6',
                        strokeOpacity: 1.0,
                        strokeWeight: 3
                    });

                    routePath.setMap(map);
                }

                // 為每個景點添加標記
                locations.forEach((location, index) => {
                    const marker = new google.maps.Marker({
                        position: {lat: location.lat, lng: location.lng},
                        map: map,
                        title: location.name,
                        label: {
                            text: location.order.toString(),
                            color: 'white',
                            fontWeight: 'bold'
                        },
                        icon: {
                            url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });

                    // 創建資訊視窗內容
                    let infoContent = `
                        <div style="max-width: 300px; padding: 10px;">
                            <h3 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: bold;">
                                ${location.order}. ${location.name}
                            </h3>
                    `;

                    if (location.description) {
                        infoContent += `<p style="margin: 0 0 8px 0; color: #6b7280; font-size: 14px;">${location.description}</p>`;
                    }

                    if (location.address) {
                        infoContent += `
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: #9ca3af;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 4px;"></i>
                                ${location.address}
                            </p>
                        `;
                    }

                    if (location.rating) {
                        infoContent += `
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: #f59e0b;">
                                <i class="fas fa-star" style="margin-right: 4px;"></i>
                                評分: ${location.rating}
                            </p>
                        `;
                    }

                    if (location.url) {
                        infoContent += `
                            <a href="${location.url}" target="_blank" 
                               style="display: inline-block; margin-top: 8px; padding: 4px 8px; 
                                      background-color: #3b82f6; color: white; text-decoration: none; 
                                      border-radius: 4px; font-size: 12px;">
                                <i class="fas fa-external-link-alt" style="margin-right: 4px;"></i>
                                在 Google Maps 查看
                            </a>
                        `;
                    }

                    infoContent += '</div>';

                    const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                });

                // 如果只有一個地點，設置適當的縮放級別
                if (locations.length === 1) {
                    map.setZoom(15);
                }
            }

            // 錯誤處理
            window.gm_authFailure = function () {
                showError('error', 'Google Maps API 認證失敗', '請檢查 API 金鑰設定');
            };

            // 頁面載入時開始載入地圖資料
            document.addEventListener('DOMContentLoaded', function () {
                loadMapData();
            });
        </script>
    {% endif %}

    <!-- 建立地點模態對話框 -->
    <div id="createLocationModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form id="createLocationForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <h3 class="font-bold text-lg mb-4">
                    <i class="fas fa-plus text-primary mr-2"></i>
                    新增地點
                </h3>

                <!-- 必填欄位 -->
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">地點名稱 <span class="text-error">*</span></span>
                    </label>
                    <input type="text" name="name" placeholder="請輸入地點名稱" class="input input-bordered w-full"
                           required>
                </div>

                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">地址 <span class="text-error">*</span></span>
                    </label>
                    <input type="text" name="address" placeholder="請輸入地址" class="input input-bordered w-full"
                           required>
                </div>

                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">Google Maps 網址 <span class="text-error">*</span></span>
                    </label>
                    <input type="url" name="google_maps_url" placeholder="請貼上 Google Maps 網址"
                           class="input input-bordered w-full" required>
                </div>

                <!-- 選填欄位 -->
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">地點描述</span>
                    </label>
                    <textarea name="description" class="textarea textarea-bordered" placeholder="請輸入地點描述"
                              rows="2"></textarea>
                </div>

                <!-- 時段選擇 -->
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">時段</span>
                    </label>
                    <select name="time_slot" class="select select-bordered w-full">
                        <option value="morning" selected>上午</option>
                        <option value="afternoon">下午</option>
                        <option value="evening">晚上</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">到達時間</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" name="arrived_hour" min="0" max="23" placeholder="時"
                                   class="input input-bordered w-20">
                            <input type="number" name="arrived_minute" min="0" max="59" placeholder="分"
                                   class="input input-bordered w-20">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">離開時間</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" name="departure_hour" min="0" max="23" placeholder="時"
                                   class="input input-bordered w-20">
                            <input type="number" name="departure_minute" min="0" max="59" placeholder="分"
                                   class="input input-bordered w-20">
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn" onclick="closeCreateLocationModal()">取消</button>
                    <button type="submit" class="btn btn-primary">建立地點</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯地點模態對話框 -->
    <div id="editLocationModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form id="editLocationForm" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="editLocationId" name="location_id">

                <h3 class="font-bold text-lg mb-4">
                    <i class="fas fa-edit text-secondary mr-2"></i>
                    編輯地點時間
                </h3>

                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    編輯地點時可修改時段、到達和離開時間，其他資訊請於後台管理介面修改。
                </div>

                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">地點名稱</span>
                    </label>
                    <input type="text" id="editLocationName" class="input input-bordered w-full" disabled>
                </div>

                <!-- 時段選擇 -->
                <div class="form-control w-full mb-4">
                    <label class="label">
                        <span class="label-text">時段</span>
                    </label>
                    <select id="editTimeSlot" name="time_slot" class="select select-bordered w-full">
                        <option value="morning">上午</option>
                        <option value="afternoon">下午</option>
                        <option value="evening">晚上</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">到達時間</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" id="editArrivedHour" name="arrived_hour" min="0" max="23"
                                   placeholder="時" class="input input-bordered w-20">
                            <input type="number" id="editArrivedMinute" name="arrived_minute" min="0" max="59"
                                   placeholder="分" class="input input-bordered w-20">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">離開時間</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" id="editDepartureHour" name="departure_hour" min="0" max="23"
                                   placeholder="時" class="input input-bordered w-20">
                            <input type="number" id="editDepartureMinute" name="departure_minute" min="0" max="59"
                                   placeholder="分" class="input input-bordered w-20">
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn" onclick="closeEditLocationModal()">取消</button>
                    <button type="submit" class="btn btn-secondary">更新時間</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 新增地點相關函數
        function openCreateLocationModal() {
            document.getElementById('createLocationModal').classList.add('modal-open');
        }

        function closeCreateLocationModal() {
            document.getElementById('createLocationModal').classList.remove('modal-open');
            document.getElementById('createLocationForm').reset();
        }

        function openEditLocationModal(locationId, locationName, timeSlot, arrivedHour, arrivedMinute, departureHour, departureMinute) {
            document.getElementById('editLocationId').value = locationId;
            document.getElementById('editLocationName').value = locationName;
            document.getElementById('editTimeSlot').value = timeSlot;

            // 設定時間值
            document.getElementById('editArrivedHour').value = arrivedHour !== null ? arrivedHour : '';
            document.getElementById('editArrivedMinute').value = arrivedMinute !== null ? arrivedMinute : '';
            document.getElementById('editDepartureHour').value = departureHour !== null ? departureHour : '';
            document.getElementById('editDepartureMinute').value = departureMinute !== null ? departureMinute : '';

            // 設定表單 action
            const form = document.getElementById('editLocationForm');
            form.action = `/itineraries/{{ itinerary.id }}/locations/${locationId}/edit/`;

            document.getElementById('editLocationModal').classList.add('modal-open');
        }

        function closeEditLocationModal() {
            document.getElementById('editLocationModal').classList.remove('modal-open');
            document.getElementById('editLocationForm').reset();
        }

        // 刪除地點
        function deleteLocation(locationId) {
            if (confirm('確定要刪除這個地點嗎？')) {
                fetch(`/itineraries/{{ itinerary.id }}/locations/${locationId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.error || '刪除失敗');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('刪除地點時發生錯誤');
                    });
            }
        }

        // 拖拉排序功能
        let draggedElement = null;

        function initializeDragAndDrop() {
            const locationItems = document.querySelectorAll('.location-item');
            const containers = document.querySelectorAll('.locations-container');

            locationItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            // 為容器添加拖曳事件
            containers.forEach(container => {
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('drop', handleDrop);
                container.addEventListener('dragleave', (e) => {
                    // 只有當滑鼠離開容器且不在其子元素上時才清除效果
                    if (!container.contains(e.relatedTarget)) {
                        container.classList.remove('drag-over');
                    }
                });
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';

            // 設定拖拉效果
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }

            e.dataTransfer.dropEffect = 'move';

            // 檢查是否拖曳到容器上
            const container = e.target.closest('.locations-container');
            if (container && !container.classList.contains('drag-over')) {
                container.classList.add('drag-over');
            }

            // 添加視覺提示
            const locationItem = e.target.closest('.location-item');
            if (locationItem && locationItem !== draggedElement) {
                const rect = locationItem.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (e.clientY < midY) {
                    locationItem.style.borderTop = '3px solid #3b82f6';
                    locationItem.style.borderBottom = '';
                } else {
                    locationItem.style.borderBottom = '3px solid #3b82f6';
                    locationItem.style.borderTop = '';
                }
            }

            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            e.preventDefault();

            // 獲取目標位置
            const targetItem = e.target.closest('.location-item');
            const targetContainer = e.target.closest('.locations-container');
            
            if (!targetContainer) return false;

            // 獲取目標時段
            const targetTimeSlot = targetContainer.id.replace('locationsList-', '');
            
            // 更新被拖拉元素的時段屬性
            draggedElement.setAttribute('data-time-slot', targetTimeSlot);

            if (targetItem && targetItem !== draggedElement) {
                // 拖曳到另一個地點上
                const rect = targetItem.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (e.clientY < midY) {
                    targetContainer.insertBefore(draggedElement, targetItem);
                } else {
                    targetContainer.insertBefore(draggedElement, targetItem.nextSibling);
                }
            } else if (!targetItem) {
                // 拖曳到空容器
                targetContainer.appendChild(draggedElement);
            }

            // 清除拖曳效果
            clearDragEffects();
            
            // 更新順序到伺服器
            updateLocationOrder();

            return false;
        }

        function clearDragEffects() {
            // 清除所有視覺提示
            document.querySelectorAll('.location-item').forEach(item => {
                item.style.borderTop = '';
                item.style.borderBottom = '';
            });
            
            // 清除容器拖曳效果
            document.querySelectorAll('.locations-container').forEach(container => {
                container.classList.remove('drag-over');
            });
        }

        function handleDragEnd(e) {
            this.style.opacity = '';
            clearDragEffects();
            draggedElement = null;
        }

        function updateLocationOrder() {
            const locationItems = document.querySelectorAll('.location-item');
            const locationData = Array.from(locationItems).map((item, index) => ({
                id: parseInt(item.getAttribute('data-location-id')),
                time_slot: item.getAttribute('data-time-slot'),
                order: index + 1
            }));

            fetch(`/itineraries/{{ itinerary.id }}/locations/reorder/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    locations: locationData
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新每個時段內的順序標籤
                        ['morning', 'afternoon', 'evening'].forEach(timeSlot => {
                            const container = document.getElementById(`locationsList-${timeSlot}`);
                            if (container) {
                                const items = container.querySelectorAll('.location-item');
                                items.forEach((item, index) => {
                                    const badge = item.querySelector('.badge');
                                    if (badge) {
                                        const icon = badge.querySelector('i');
                                        badge.innerHTML = '';
                                        badge.appendChild(icon);
                                        badge.appendChild(document.createTextNode(` ${index + 1}`));
                                    }
                                });
                            }
                        });

                        // 顯示成功訊息（可選）
                        console.log('地點順序已更新');
                    } else {
                        alert(data.error || '更新順序失敗');
                        location.reload(); // 重新載入頁面以恢復原始順序
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新順序時發生錯誤');
                    location.reload(); // 重新載入頁面以恢復原始順序
                });
        }

        // 表單提交處理
        document.getElementById('createLocationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch(`/itineraries/{{ itinerary.id }}/locations/create/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || '建立地點失敗');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('建立地點時發生錯誤');
                });
        });

        document.getElementById('editLocationForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const locationId = document.getElementById('editLocationId').value;

            fetch(`/itineraries/{{ itinerary.id }}/locations/${locationId}/edit/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || '更新地點失敗');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新地點時發生錯誤');
                });
        });

        // 點擊模態背景關閉
        document.getElementById('createLocationModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeCreateLocationModal();
            }
        });

        document.getElementById('editLocationModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeEditLocationModal();
            }
        });


        // 初始化拖拉排序功能
        document.addEventListener('DOMContentLoaded', function () {
            {% if locations %}
                initializeDragAndDrop();
            {% endif %}
        });
    </script>

    <!-- 拖拉排序的CSS樣式 -->
    <style>
        /* 拖拉排序樣式 */
        .location-item {
            transition: all 0.3s ease;
        }

        .location-item:hover .drag-handle {
            color: #6b7280 !important;
        }

        .location-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .location-item.drag-over-top {
            border-top: 3px solid #3b82f6;
        }

        .location-item.drag-over-bottom {
            border-bottom: 3px solid #3b82f6;
        }

        .drag-handle {
            transition: color 0.2s ease;
        }

        .drag-handle:hover {
            color: #374151 !important;
        }

        .drag-handle:active {
            color: #1f2937 !important;
        }

        /* 改善觸控設備的拖拉體驗 */
        @media (pointer: coarse) {
            .drag-handle {
                font-size: 1.25rem;
                padding: 0.5rem;
            }
        }
        
        /* 時段容器樣式 */
        .locations-container {
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
            transition: background-color 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
        }
        
        /* 自定義滾動條樣式 */
        .locations-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .locations-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .locations-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .locations-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .locations-container.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
        }
        
        /* 空時段的提示 */
        .locations-container:empty::after {
            content: "拖拉地點到此時段";
            display: block;
            text-align: center;
            padding: 2rem;
            color: rgba(0, 0, 0, 0.3);
            font-style: italic;
        }
        
        /* 當地點超過5個時顯示淡出效果 */
        .locations-container.has-overflow {
            position: relative;
        }
        
        .locations-container.has-overflow::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.9));
            pointer-events: none;
        }
    </style>
{% endblock %}